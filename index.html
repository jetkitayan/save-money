<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>節約ログ</title>
  <style>
    * { box-sizing: border-box; }
    body { margin: 0; font-family: system-ui, -apple-system, "Segoe UI", sans-serif; background: #fafafa; }
    header { position: sticky; top: 0; background: #fff; border-bottom: 1px solid #e6e6e6; padding: 12px 14px; z-index: 10; }
    h1 { margin: 0; font-size: 18px; }
    main { max-width: 980px; margin: 0 auto; padding: 14px; }
    .card { background: #fff; border: 1px solid #e6e6e6; border-radius: 12px; padding: 12px; }
    .grid { display: grid; gap: 10px; }

    /* スマホ：全部縦並び（←重要） */
    .grid.cols {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    
    /* PCだけ横並び */
    @media (min-width: 720px) {
      .grid.cols {
        display: grid;
        grid-template-columns: 240px 240px 180px 1fr 140px auto;
        align-items: end;
      }
    }

    label { font-size: 12px; color: #555; display: block; margin-bottom: 6px; }
    input, textarea, select {
      width: 100%;
      padding: 10px 10px;
      border: 1px solid #d7d7d7;
      border-radius: 10px;
      font-size: 15px;
      background: #fff;
    }
    button {
      padding: 10px 14px;
      border-radius: 10px;
      border: 1px solid #cfcfcf;
      background: #fff;
      cursor: pointer;
      font-size: 14px;
    }
    button:active { transform: translateY(1px); }
    .row { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
    .muted { color: #666; font-size: 12px; }

    .sumGroupTitle { margin: 0 0 8px; font-size: 14px; color: #333; }
    .sumBox { padding: 10px; border: 1px solid #e6e6e6; border-radius: 12px; background: #fbfbfb; }
    .sumBox .k { font-size: 12px; color: #666; }
    .sumBox .v { font-size: 18px; font-weight: 700; margin-top: 6px; }

    /* iPhone備考幅対策：固定幅を減らして備考を広くする */
    table { width: 100%; border-collapse: collapse; table-layout: auto; }
    th, td { padding: 10px 8px; border-bottom: 1px solid #eee; text-align: left; vertical-align: top; }
    th { font-size: 12px; color: #666; font-weight: 600; white-space: nowrap; }
    td { font-size: 14px; }
    .amt, .kcal { font-weight: 700; }
    .pill { display: inline-block; padding: 2px 8px; border-radius: 999px; border: 1px solid #ddd; font-size: 12px; background: #fff; }
    .pill.ok { border-color: #cfe8d5; background: #f3fbf5; }
    .pill.ng { border-color: #f0caca; background: #fff6f6; }
    .right { text-align: right; }

    .note-edit {
      width: 100%;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid #ddd;
      font-size: 14px;
    }

    @media (max-width: 600px) {
      /* スマホで横幅を食う列を少し縮める */
      .th-date { width: 105px !important; }
      .th-judge { width: 72px !important; }
      .th-amt { width: 78px !important; }
      .th-kcal { width: 72px !important; }
      .th-type { width: 72px !important; }
      .th-ops { width: 110px !important; }
    }

    /* 合計欄は常に横並び */
    .grid.sums {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
    }
    
    /* iPhoneでは少し詰める */
    @media (max-width: 600px) {
      .grid.sums {
        gap: 6px;
      }
    
      .sumBox .v {
        font-size: 15px; /* 数字少し小さく */
      }
    
      .sumBox .k {
        font-size: 11px;
      }
    }

    /* 合計4つを横に並べつつ、潰れたら横スクロールできるようにする */
    @media (max-width: 600px) {
      .grid.sums {
        grid-template-columns: repeat(4, minmax(90px, 1fr));
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        padding-bottom: 4px;
      }
      .sumBox {
        min-width: 90px;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>節約ログ</h1>
    <div class="muted">
      金額：出費は <b>+</b>、節約は <b>-</b> ／ カロリー：摂取は <b>+</b>、削減は <b>-</b> ／ OK・NGで評価も記録
    </div>
  </header>

  <main class="grid" style="gap:14px;">
    <!-- 入力 -->
    <section class="card">
      <div class="grid cols">
        <!-- 金額 -->
        <div>
          <label>金額（出費/節約）</label>
          <div class="row">
            <select id="signMoney" style="width:110px; flex:0 0 auto;">
              <option value="plus" selected>出費（+）</option>
              <option value="minus">節約（-）</option>
            </select>
            <input id="amount" inputmode="numeric" placeholder="300 / 1200" />
          </div>
          <div class="muted">※ 符号は左で選択（スマホで-が打てない問題を回避）</div>
        </div>

        <!-- カロリー -->
        <div>
          <label>カロリー（摂取/削減）</label>
          <div class="row">
            <select id="signKcal" style="width:110px; flex:0 0 auto;">
              <option value="plus" selected>摂取（+）</option>
              <option value="minus">削減（-）</option>
            </select>
            <input id="kcal" inputmode="numeric" placeholder="250 / 500" />
          </div>
          <div class="muted">※ 例：間食 250kcal → +250 ／ 運動で 200kcal 相当削減 → -200</div>
        </div>

        <div>
          <label for="type">種別</label>
          <input id="type"
                 list="typeList"
                 placeholder="例：昼食 / カフェ / 交通 / 買い物 / 運動" />
          
          <datalist id="typeList"></datalist>
        </div>

        <div>
          <label for="note">備考</label>
          <input id="note" placeholder="例：コンビニやめた / 弁当持参 / ランニング30分" />
        </div>

        <div>
          <label for="judge">OK / NG</label>
          <select id="judge">
            <option value="OK" selected>OK（良い）</option>
            <option value="NG">NG（微妙）</option>
          </select>
        </div>

        <div class="row">
          <button id="addBtn">追加</button>
          <button id="clearBtn" title="全データ削除">全削除</button>
        </div>
      </div>
    </section>

    <!-- 合計：金額 -->
    <section class="card">
      <h3 class="sumGroupTitle">金額 合計</h3>
      <div class="grid sums">
        <div class="sumBox"><div class="k">直近100件</div><div class="v" id="sumMoney100">0</div></div>
        <div class="sumBox"><div class="k">直近50件</div><div class="v" id="sumMoney50">0</div></div>
        <div class="sumBox"><div class="k">直近20件</div><div class="v" id="sumMoney20">0</div></div>
        <div class="sumBox"><div class="k">直近10件</div><div class="v" id="sumMoney10">0</div></div>
      </div>
      <div class="muted" style="margin-top:10px;">※ 合計は「金額の合算」。出費（+）は増える／節約（-）は減る</div>
    </section>

    <!-- 合計：カロリー -->
    <section class="card">
      <h3 class="sumGroupTitle">カロリー 合計（kcal）</h3>
      <div class="grid sums">
        <div class="sumBox"><div class="k">直近100件</div><div class="v" id="sumKcal100">0</div></div>
        <div class="sumBox"><div class="k">直近50件</div><div class="v" id="sumKcal50">0</div></div>
        <div class="sumBox"><div class="k">直近20件</div><div class="v" id="sumKcal20">0</div></div>
        <div class="sumBox"><div class="k">直近10件</div><div class="v" id="sumKcal10">0</div></div>
      </div>
      <div class="muted" style="margin-top:10px;">※ 合計は「カロリーの合算」。摂取（+）は増える／削減（-）は減る</div>
    </section>

    <!-- 一覧 -->
    <section class="card">
      <div class="row" style="justify-content:space-between;">
        <div class="muted">最新が上。最大 1000 件まで保存。備考は一覧で編集可。</div>
        <button id="exportBtn">JSONエクスポート</button>
      </div>
      <div style="overflow:auto; margin-top:10px;">
        <table>
          <thead>
            <tr>
              <th class="th-date" style="width:130px;">日時</th>
              <th class="th-judge" style="width:90px;">OK/NG</th>
              <th class="th-amt right" style="width:90px;">金額</th>
              <th class="th-kcal right" style="width:90px;">kcal</th>
              <th class="th-type" style="width:110px;">種別</th>
              <th>備考</th>
              <th class="th-ops" style="width:120px;"></th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </section>
  </main>

<script>
(() => {
  const KEY = "saving_log_v3"; // カロリー追加でバージョン変更
  const MAX_SAVE = 1000;

  const $ = (id) => document.getElementById(id);

  const signMoneyEl = $("signMoney");
  const amountEl = $("amount");
  const signKcalEl = $("signKcal");
  const kcalEl = $("kcal");
  const typeEl = $("type");
  const noteEl = $("note");
  const judgeEl = $("judge");
  const addBtn = $("addBtn");
  const clearBtn = $("clearBtn");
  const exportBtn = $("exportBtn");

  const sumMoney100El = $("sumMoney100");
  const sumMoney50El  = $("sumMoney50");
  const sumMoney20El  = $("sumMoney20");
  const sumMoney10El  = $("sumMoney10");

  const sumKcal100El = $("sumKcal100");
  const sumKcal50El  = $("sumKcal50");
  const sumKcal20El  = $("sumKcal20");
  const sumKcal10El  = $("sumKcal10");

  const tbody = $("tbody");

  function renderTypeList() {
    const dl = document.getElementById("typeList");
    if (!dl) return;
  
    // 重複なしで種別を抽出
    const types = [...new Set(
      items
        .map(x => (x.type || "").trim())
        .filter(Boolean)
    )];
  
    dl.innerHTML = "";
  
    for (const t of types) {
      const opt = document.createElement("option");
      opt.value = t;
      dl.appendChild(opt);
    }
  }
  
  function newId() {
    if (crypto && crypto.randomUUID) return crypto.randomUUID();
    return String(Date.now()) + "_" + Math.random().toString(16).slice(2);
  }

  /** @type {{id:string, ts:number, amount:number, kcal:number, type:string, note:string, judge:"OK"|"NG"}[]} */
  let items = load();

  function load() {
    try {
      const raw = localStorage.getItem(KEY);
      if (!raw) return [];
      const parsed = JSON.parse(raw);
      if (!Array.isArray(parsed)) return [];
      return parsed
        .filter(x => x && typeof x === "object")
        .map(x => ({
          id: String(x.id || newId()),
          ts: Number(x.ts || Date.now()),
          amount: Number(x.amount || 0),
          kcal: Number(x.kcal || 0),
          type: String(x.type || ""),
          note: String(x.note || ""),
          judge: (x.judge === "NG" ? "NG" : "OK")
        }))
        .slice(0, MAX_SAVE);
    } catch {
      return [];
    }
  }

  function save() {
    localStorage.setItem(KEY, JSON.stringify(items.slice(0, MAX_SAVE)));
  }

  function yen(n) {
    const sign = n > 0 ? "+" : (n < 0 ? "-" : "");
    const abs = Math.abs(n);
    const isInt = Number.isInteger(abs);
    const s = isInt ? abs.toLocaleString("ja-JP") : abs.toLocaleString("ja-JP", { maximumFractionDigits: 2 });
    return sign + s;
  }

  function kcalFmt(n) {
    const sign = n > 0 ? "+" : (n < 0 ? "-" : "");
    const abs = Math.abs(n);
    const isInt = Number.isInteger(abs);
    const s = isInt ? abs.toLocaleString("ja-JP") : abs.toLocaleString("ja-JP", { maximumFractionDigits: 1 });
    return sign + s;
  }

  function sumLastMoney(k) {
    return items.slice(0, k).reduce((acc, x) => acc + (Number(x.amount) || 0), 0);
  }
  function sumLastKcal(k) {
    return items.slice(0, k).reduce((acc, x) => acc + (Number(x.kcal) || 0), 0);
  }

  function renderSums() {
    sumMoney100El.textContent = yen(sumLastMoney(100));
    sumMoney50El.textContent  = yen(sumLastMoney(50));
    sumMoney20El.textContent  = yen(sumLastMoney(20));
    sumMoney10El.textContent  = yen(sumLastMoney(10));

    sumKcal100El.textContent = kcalFmt(sumLastKcal(100));
    sumKcal50El.textContent  = kcalFmt(sumLastKcal(50));
    sumKcal20El.textContent  = kcalFmt(sumLastKcal(20));
    sumKcal10El.textContent  = kcalFmt(sumLastKcal(10));
  }

  function fmtDate(ts) {
    const d = new Date(ts);
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, "0");
    const day = String(d.getDate()).padStart(2, "0");
    const hh = String(d.getHours()).padStart(2, "0");
    const mm = String(d.getMinutes()).padStart(2, "0");
    // スマホは短縮
    if (window.innerWidth < 600) return `${m}/${day} ${hh}:${mm}`;
    return `${y}/${m}/${day} ${hh}:${mm}`;
  }

  function escapeHtml(str) {
    return String(str).replace(/[&<>"']/g, (m) => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[m]));
  }

  function toggleJudge(id) {
    const it = items.find(x => x.id === id);
    if (!it) return;
    it.judge = (it.judge === "OK" ? "NG" : "OK");
    save();
    refresh();
  }

  function removeItem(id) {
    items = items.filter(it => it.id !== id);
    save();
    refresh();
  }

  function renderTable() {
    tbody.innerHTML = "";
    for (const x of items) {
      const tr = document.createElement("tr");

      const tdDate = document.createElement("td");
      tdDate.textContent = fmtDate(x.ts);

      const tdJudge = document.createElement("td");
      const judgeBtn = document.createElement("button");
      judgeBtn.textContent = x.judge;
      judgeBtn.title = "クリックで OK/NG 切替";
      judgeBtn.addEventListener("click", () => toggleJudge(x.id));
      tdJudge.appendChild(judgeBtn);

      const tdAmt = document.createElement("td");
      tdAmt.className = "right amt";
      tdAmt.textContent = yen(x.amount);

      const tdKcal = document.createElement("td");
      tdKcal.className = "right kcal";
      tdKcal.textContent = kcalFmt(x.kcal);

      const tdType = document.createElement("td");
      tdType.innerHTML = x.type ? `<span class="pill">${escapeHtml(x.type)}</span>` : "";

      const tdNote = document.createElement("td");

      // 備考を編集できる input にする
      const noteInput = document.createElement("input");
      noteInput.type = "text";
      noteInput.value = x.note || "";
      noteInput.placeholder = "備考（編集可）";
      noteInput.className = "note-edit";

      let original = noteInput.value;

      const commit = () => {
        const it = items.find(it => it.id === x.id);
        if (!it) return;
        it.note = noteInput.value.trim();
        save();
      };

      noteInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") noteInput.blur();
        if (e.key === "Escape") { noteInput.value = original; noteInput.blur(); }
      });
      noteInput.addEventListener("focus", () => { original = noteInput.value; });
      noteInput.addEventListener("blur", commit);
      noteInput.addEventListener("change", commit);

      tdNote.appendChild(noteInput);

      const tdOps = document.createElement("td");
      tdOps.className = "right";
      const pill = document.createElement("span");
      pill.className = "pill " + (x.judge === "OK" ? "ok" : "ng");
      pill.textContent = (x.judge === "OK" ? "良い" : "微妙");

      const delBtn = document.createElement("button");
      delBtn.textContent = "削除";
      delBtn.addEventListener("click", () => removeItem(x.id));

      tdOps.append(pill, document.createTextNode(" "), delBtn);

      tr.append(tdDate, tdJudge, tdAmt, tdKcal, tdType, tdNote, tdOps);
      tbody.appendChild(tr);
    }
  }

  function refresh() {
    renderSums();
    renderTable();
    renderTypeList(); // ←追加
  }

  function parseNumberOnly(s) {
    const t = String(s ?? "").trim();
    if (!t) return 0; // 未入力は 0 扱い
    const normalized = t.replace(/,/g, "");
    if (!/^(\d+(\.\d+)?)$/.test(normalized)) return null;
    const n = Number(normalized);
    if (!Number.isFinite(n)) return null;
    return n;
  }

  function addItem() {
    const moneyN = parseNumberOnly(amountEl.value);
    if (moneyN === null) { alert("金額は数字で入力してください（例：300）"); amountEl.focus(); return; }
    const kcalN = parseNumberOnly(kcalEl.value);
    if (kcalN === null) { alert("カロリーは数字で入力してください（例：250）"); kcalEl.focus(); return; }

    const moneySign = (signMoneyEl.value === "minus") ? -1 : 1;
    const kcalSign  = (signKcalEl.value === "minus") ? -1 : 1;

    const item = {
      id: newId(),
      ts: Date.now(),
      amount: moneyN * moneySign,
      kcal: kcalN * kcalSign,
      type: typeEl.value.trim(),
      note: noteEl.value.trim(),
      judge: (judgeEl.value === "NG" ? "NG" : "OK")
    };

    items.unshift(item);
    items = items.slice(0, MAX_SAVE);
    save();
    refresh();

    amountEl.value = "";
    kcalEl.value = "";
    noteEl.value = "";
    judgeEl.value = "OK";
    signMoneyEl.value = "plus";
    signKcalEl.value = "plus";
    amountEl.focus();
  }

  addBtn.addEventListener("click", addItem);
  amountEl.addEventListener("keydown", (e) => { if (e.key === "Enter") addItem(); });
  kcalEl.addEventListener("keydown", (e) => { if (e.key === "Enter") addItem(); });
  noteEl.addEventListener("keydown", (e) => { if (e.key === "Enter") addItem(); });

  clearBtn.addEventListener("click", () => {
    const ok = confirm("全データを削除します。よろしいですか？");
    if (!ok) return;
    items = [];
    save();
    refresh();
  });

  exportBtn.addEventListener("click", () => {
    const data = JSON.stringify(items, null, 2);
    const blob = new Blob([data], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "saving_log.json";
    a.click();
    URL.revokeObjectURL(url);
  });

  refresh();
})();
</script>
</body>
</html>
