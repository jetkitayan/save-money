<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>節約ログ</title>
  <style>
    * { box-sizing: border-box; }
    body { margin: 0; font-family: system-ui, -apple-system, "Segoe UI", sans-serif; background: #fafafa; }
    header { position: sticky; top: 0; background: #fff; border-bottom: 1px solid #e6e6e6; padding: 12px 14px; z-index: 10; }
    h1 { margin: 0; font-size: 18px; }
    main { max-width: 980px; margin: 0 auto; padding: 14px; }
    .card { background: #fff; border: 1px solid #e6e6e6; border-radius: 12px; padding: 12px; }
    .grid { display: grid; gap: 10px; }
    @media (min-width: 720px) {
      .grid.cols { grid-template-columns: 170px 180px 1fr 140px auto; align-items: end; }
      .grid.sums { grid-template-columns: repeat(4, 1fr); }
    }
    label { font-size: 12px; color: #555; display: block; margin-bottom: 6px; }
    input, textarea, select {
      width: 100%;
      padding: 10px 10px;
      border: 1px solid #d7d7d7;
      border-radius: 10px;
      font-size: 15px;
      background: #fff;
    }
    textarea { resize: vertical; min-height: 42px; }
    button {
      padding: 10px 14px;
      border-radius: 10px;
      border: 1px solid #cfcfcf;
      background: #fff;
      cursor: pointer;
      font-size: 14px;
    }
    button:active { transform: translateY(1px); }
    .row { display: flex; gap: 8px; flex-wrap: wrap; }
    .muted { color: #666; font-size: 12px; }
    .sumBox { padding: 10px; border: 1px solid #e6e6e6; border-radius: 12px; background: #fbfbfb; }
    .sumBox .k { font-size: 12px; color: #666; }
    .sumBox .v { font-size: 18px; font-weight: 700; margin-top: 6px; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 10px 8px; border-bottom: 1px solid #eee; text-align: left; vertical-align: top; }
    th { font-size: 12px; color: #666; font-weight: 600; }
    td { font-size: 14px; }
    .amt { font-weight: 700; }
    .pill { display: inline-block; padding: 2px 8px; border-radius: 999px; border: 1px solid #ddd; font-size: 12px; background: #fff; }
    .pill.ok { border-color: #cfe8d5; background: #f3fbf5; }
    .pill.ng { border-color: #f0caca; background: #fff6f6; }
    .right { text-align: right; }
  </style>
</head>
<body>
  <header>
    <h1>節約ログ</h1>
    <div class="muted">出費は <b>+</b>、節約できたら <b>-</b>（例：+300、-120）／ OK・NGで「いい出費だったか」も記録</div>
  </header>

  <main class="grid" style="gap:14px;">
    <!-- 入力 -->
    <section class="card">
      <div class="grid cols">
        <div>
          <label>金額（出費/節約）</label>
          <div style="display:flex; gap:8px; align-items:center;">
            <select id="sign" style="width:110px;">
              <option value="plus" selected>出費（+）</option>
              <option value="minus">節約（-）</option>
            </select>
            <input id="amount" inputmode="numeric" placeholder="300 / 1200" />
          </div>
          <div class="muted">※ 符号は左で選択（スマホで-が打てない問題を回避）</div>
        </div>

        <div>
          <label for="type">種別</label>
          <input id="type" placeholder="例：昼食 / カフェ / 交通 / 買い物" />
        </div>

        <div>
          <label for="note">備考</label>
          <input id="note" placeholder="例：コンビニやめた / 弁当持参" />
        </div>

        <div>
          <label for="judge">OK / NG</label>
          <select id="judge">
            <option value="OK" selected>OK（良い出費）</option>
            <option value="NG">NG（微妙な出費）</option>
          </select>
        </div>

        <div class="row">
          <button id="addBtn">追加</button>
          <button id="clearBtn" title="全データ削除">全削除</button>
        </div>
      </div>
    </section>

    <!-- 合計 -->
    <section class="card">
      <div class="grid sums">
        <div class="sumBox">
          <div class="k">直近100件 合計</div>
          <div class="v" id="sum100">0</div>
        </div>
        <div class="sumBox">
          <div class="k">直近50件 合計</div>
          <div class="v" id="sum50">0</div>
        </div>
        <div class="sumBox">
          <div class="k">直近20件 合計</div>
          <div class="v" id="sum20">0</div>
        </div>
        <div class="sumBox">
          <div class="k">直近10件 合計</div>
          <div class="v" id="sum10">0</div>
        </div>
      </div>
      <div class="muted" style="margin-top:10px;">
        ※ 合計は「入力金額の合算」。OK/NGは評価ラベル（合計計算には影響しない）
      </div>
    </section>

    <!-- 一覧 -->
    <section class="card">
      <div class="row" style="justify-content:space-between; align-items:center;">
        <div class="muted">最新が上。最大 1000 件まで保存。</div>
        <button id="exportBtn">JSONエクスポート</button>
      </div>
      <div style="overflow:auto; margin-top:10px;">
        <table>
          <thead>
            <tr>
              <th style="width:160px;">日時</th>
              <th style="width:120px;">OK/NG</th>
              <th style="width:130px;" class="right">金額</th>
              <th style="width:160px;">種別</th>
              <th>備考</th>
              <th style="width:150px;"></th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </section>
  </main>

<script>
(() => {
  const KEY = "saving_log_v2"; // v1と衝突しないように
  const MAX_SAVE = 1000;

  const $ = (id) => document.getElementById(id);

  const signEl = $("sign");
  const amountEl = $("amount");
  const typeEl = $("type");
  const noteEl = $("note");
  const judgeEl = $("judge");
  const addBtn = $("addBtn");
  const clearBtn = $("clearBtn");
  const exportBtn = $("exportBtn");

  const sum100El = $("sum100");
  const sum50El = $("sum50");
  const sum20El = $("sum20");
  const sum10El = $("sum10");
  const tbody = $("tbody");

  /** @type {{id:string, ts:number, amount:number, type:string, note:string, judge:"OK"|"NG"}[]} */
  let items = load();

  function load() {
    try {
      const raw = localStorage.getItem(KEY);
      if (!raw) return [];
      const parsed = JSON.parse(raw);
      if (!Array.isArray(parsed)) return [];
      return parsed
        .filter(x => x && typeof x === "object")
        .map(x => ({
          id: String(x.id || crypto.randomUUID()),
          ts: Number(x.ts || Date.now()),
          amount: Number(x.amount || 0),
          type: String(x.type || ""),
          note: String(x.note || ""),
          judge: (x.judge === "NG" ? "NG" : "OK")
        }))
        .slice(0, MAX_SAVE);
    } catch {
      return [];
    }
  }

  function save() {
    localStorage.setItem(KEY, JSON.stringify(items.slice(0, MAX_SAVE)));
  }

  function parseAmount(s) {
    const t = String(s ?? "").trim();
    if (!t) return null;
    const normalized = t.replace(/,/g, "");
    if (!/^[-+]?(\d+(\.\d+)?)$/.test(normalized)) return null;
    const n = Number(normalized);
    if (!Number.isFinite(n)) return null;
    return n;
  }

  function yen(n) {
    const sign = n > 0 ? "+" : (n < 0 ? "-" : "");
    const abs = Math.abs(n);
    const isInt = Number.isInteger(abs);
    const s = isInt ? abs.toLocaleString("ja-JP") : abs.toLocaleString("ja-JP", { maximumFractionDigits: 2 });
    return sign + s;
  }

  function sumLast(k) {
    const slice = items.slice(0, k);
    return slice.reduce((acc, x) => acc + (Number(x.amount) || 0), 0);
  }

  function renderSums() {
    sum100El.textContent = yen(sumLast(100));
    sum50El.textContent  = yen(sumLast(50));
    sum20El.textContent  = yen(sumLast(20));
    sum10El.textContent  = yen(sumLast(10));
  }

  function fmtDate(ts) {
    const d = new Date(ts);
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, "0");
    const day = String(d.getDate()).padStart(2, "0");
    const hh = String(d.getHours()).padStart(2, "0");
    const mm = String(d.getMinutes()).padStart(2, "0");
    return `${y}/${m}/${day} ${hh}:${mm}`;
  }

  function escapeHtml(str) {
    return String(str).replace(/[&<>"']/g, (m) => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[m]));
  }

  function toggleJudge(id) {
    const it = items.find(x => x.id === id);
    if (!it) return;
    it.judge = (it.judge === "OK" ? "NG" : "OK");
    save();
    refresh();
  }

  function removeItem(id) {
    items = items.filter(it => it.id !== id);
    save();
    refresh();
  }

  function renderTable() {
    tbody.innerHTML = "";
    for (const x of items) {
      const tr = document.createElement("tr");

      const tdDate = document.createElement("td");
      tdDate.textContent = fmtDate(x.ts);

      const tdJudge = document.createElement("td");
      const judgeBtn = document.createElement("button");
      judgeBtn.textContent = x.judge;
      judgeBtn.title = "クリックで OK/NG 切替";
      judgeBtn.addEventListener("click", () => toggleJudge(x.id));
      tdJudge.appendChild(judgeBtn);

      const tdAmt = document.createElement("td");
      tdAmt.className = "right amt";
      tdAmt.textContent = yen(x.amount);

      const tdType = document.createElement("td");
      tdType.innerHTML = x.type ? `<span class="pill">${escapeHtml(x.type)}</span>` : "";

      const tdNote = document.createElement("td");
      tdNote.textContent = x.note || "";

      const tdOps = document.createElement("td");
      tdOps.className = "right";
      const pill = document.createElement("span");
      pill.className = "pill " + (x.judge === "OK" ? "ok" : "ng");
      pill.textContent = (x.judge === "OK" ? "良い" : "微妙");
      const delBtn = document.createElement("button");
      delBtn.textContent = "削除";
      delBtn.addEventListener("click", () => removeItem(x.id));
      tdOps.append(pill, document.createTextNode(" "), delBtn);

      tr.append(tdDate, tdJudge, tdAmt, tdType, tdNote, tdOps);
      tbody.appendChild(tr);
    }
  }

  function refresh() {
    renderSums();
    renderTable();
  }

  function parseNumberOnly(s) {
    const t = String(s ?? "").trim();
    if (!t) return null;
    const normalized = t.replace(/,/g, "");
    if (!/^(\d+(\.\d+)?)$/.test(normalized)) return null; // マイナス禁止
    const n = Number(normalized);
    if (!Number.isFinite(n)) return null;
    return n;
  }
  
  function addItem() {
    const n = parseNumberOnly(amountEl.value);
    if (n === null) {
      alert("金額を数字で入力してください（例：300, 1200）");
      amountEl.focus();
      return;
    }
  
    const sign = (document.getElementById("sign").value === "minus") ? -1 : 1;
    const amt = n * sign;
  
    const item = {
      id: crypto.randomUUID(),
      ts: Date.now(),
      amount: amt,
      type: typeEl.value.trim(),
      note: noteEl.value.trim(),
      judge: (judgeEl.value === "NG" ? "NG" : "OK")
    };
  
    items.unshift(item);
    items = items.slice(0, MAX_SAVE);
    save();
    refresh();
  
    amountEl.value = "";
    noteEl.value = "";
    judgeEl.value = "OK";
    document.getElementById("sign").value = "plus";
    amountEl.focus();
  }
  
  addBtn.addEventListener("click", addItem);
  amountEl.addEventListener("keydown", (e) => { if (e.key === "Enter") addItem(); });
  noteEl.addEventListener("keydown", (e) => { if (e.key === "Enter") addItem(); });

  clearBtn.addEventListener("click", () => {
    const ok = confirm("全データを削除します。よろしいですか？");
    if (!ok) return;
    items = [];
    save();
    refresh();
  });

  exportBtn.addEventListener("click", () => {
    const data = JSON.stringify(items, null, 2);
    const blob = new Blob([data], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "saving_log.json";
    a.click();
    URL.revokeObjectURL(url);
  });

  refresh();
})();
</script>
</body>
</html>
